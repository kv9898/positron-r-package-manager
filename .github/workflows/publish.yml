name: Publish Extension

on:
  workflow_dispatch:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  preparation:
    name: âœ… Preparation
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.extract.outputs.version }}

    steps:
      - name: ğŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install dependencies
        run: yarn --frozen-lockfile

      - name: ğŸ”§ Build extension
        run: yarn run package

      - name: ğŸ“¦ Package extension
        run: npx vsce package

      - name: ğŸ· Extract version
        id: extract
        run: echo "version=$(node -p 'require(\"./package.json\").version')" >> "$GITHUB_OUTPUT"

  publish_ovsx:
    name: ğŸš€ Publish to Open VSX
    needs: preparation
    runs-on: ubuntu-latest
    continue-on-error: true # GitHub release will still be created despite Open VSX errors.

    steps:
      - name: ğŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Publish extension to Open VSX
        uses: HaaLeo/publish-vscode-extension@v2
        with:
          pat: ${{ secrets.OPEN_VSX_TOKEN }}
          packagePath: "*.vsix"

  github_release:
    name: ğŸ“ Create GitHub Release
    needs: preparation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¤ Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.vsix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
