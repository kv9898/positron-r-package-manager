# DEPRECATED: This workflow doesn't work reliably because GitHub Actions cache 
# sharing between separate workflows is limited. Use ci.yml instead which 
# combines setup and testing in a single job.

name: Setup for Copilot Agent (DEPRECATED)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - 'copilot/**'
  pull_request:
    branches:
      - main

jobs:
  setup:
    name: üöÄ Setup Dependencies and Pre-download VS Code
    runs-on: ubuntu-latest
    
    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v4

      - name: üß∞ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: üóÇÔ∏è Cache VS Code test binaries
        uses: actions/cache@v4
        with:
          path: .vscode-test
          key: vscode-test-${{ runner.os }}-${{ hashFiles('package.json') }}
          restore-keys: |
            vscode-test-${{ runner.os }}-

      - name: üì¶ Install yarn dependencies
        run: yarn install --frozen-lockfile

      - name: üèóÔ∏è Build extension
        run: yarn run compile

      - name: üß™ Compile tests
        run: yarn run compile-tests

      - name: üì• Pre-download VS Code for testing
        run: |
          # Check if VS Code is already cached
          if [ -d ".vscode-test" ] && [ "$(ls -A .vscode-test)" ]; then
            echo "‚úÖ VS Code test binaries already cached"
            ls -la .vscode-test/
          else
            echo "üì• Downloading VS Code test binaries..."
            
            # Create a script to pre-download VS Code test binaries
            cat > download-vscode.js << 'EOF'
          const { downloadAndUnzipVSCode } = require('@vscode/test-electron');
          
          async function main() {
            try {
              console.log('Pre-downloading VS Code for testing...');
              const vscodeExecutablePath = await downloadAndUnzipVSCode('stable');
              console.log('VS Code downloaded successfully to:', vscodeExecutablePath);
              
              // Verify the download
              const fs = require('fs');
              const path = require('path');
              if (fs.existsSync(vscodeExecutablePath)) {
                console.log('‚úÖ VS Code executable found at:', vscodeExecutablePath);
                
                // List contents of .vscode-test directory
                const testDir = '.vscode-test';
                if (fs.existsSync(testDir)) {
                  const contents = fs.readdirSync(testDir);
                  console.log('üìÅ Contents of .vscode-test directory:', contents);
                }
              } else {
                throw new Error('VS Code executable not found after download');
              }
            } catch (error) {
              console.error('‚ùå Failed to download VS Code:', error.message);
              console.error(error.stack);
              process.exit(1);
            }
          }
          
          main();
          EOF
            
            # Run the download script
            node download-vscode.js
            
            # Clean up the temporary script
            rm -f download-vscode.js
          fi
          
      - name: üîç Run linting
        run: yarn run lint

      - name: ‚úÖ Verify setup complete
        run: |
          echo "üéâ Setup completed successfully!"
          echo "üìã Summary:"
          echo "  ‚úÖ Dependencies installed with yarn"
          echo "  ‚úÖ Extension compiled"
          echo "  ‚úÖ Tests compiled"
          echo "  ‚úÖ Linting passed"
          
          # Verify VS Code test setup
          if [ -d ".vscode-test" ] && [ "$(ls -A .vscode-test)" ]; then
            echo "  ‚úÖ VS Code test binaries ready"
            echo "üìÅ VS Code test directory contents:"
            ls -la .vscode-test/
            
            # Find and display VS Code executable info
            find .vscode-test -name "code" -o -name "Code" -o -name "*.exe" | head -3 | while read file; do
              echo "üîß VS Code executable: $file"
              ls -lh "$file" 2>/dev/null || echo "  (info not available)"
            done
          else
            echo "  ‚ùå VS Code test binaries not found"
            exit 1
          fi
          
          echo ""
          echo "üîß This setup workflow ensures:"
          echo "  - All yarn dependencies are installed"
          echo "  - VS Code test binaries are pre-downloaded"
          echo "  - Extension builds successfully"
          echo "  - Tests can run without network access to update.code.visualstudio.com"